
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.0.5">
    
    
      
        <title>core - vmcnet</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.a617204b.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.9204c3b2.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../stylesheets/docstrings.css">
    
      <link rel="stylesheet" href="../../../stylesheets/sidebar.css">
    
      <link rel="stylesheet" href="../../../stylesheets/content.css">
    
    <script>__md_scope=new URL("../../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#vmcnet.physics.core" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-component="outdated" hidden>
        <aside class="md-banner md-banner--warning">
          
        </aside>
      </div>
    
    
      

  

<header class="md-header md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="vmcnet" class="md-header__button md-logo" aria-label="vmcnet" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            vmcnet
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              core
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/jeffminlin/vmcnet" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jeffminlin/vmcnet
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  
    
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../examples/harmonic_oscillator/" class="md-tabs__link md-tabs__link--active">
        API Reference
      </a>
    </li>
  

  

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../../CONTRIBUTING/" class="md-tabs__link">
      Contributing
    </a>
  </li>

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="vmcnet" class="md-nav__button md-logo" aria-label="vmcnet" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    vmcnet
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/jeffminlin/vmcnet" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jeffminlin/vmcnet
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          API Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="API Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          API Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_1">
          examples
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="examples" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          examples
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/harmonic_oscillator/" class="md-nav__link">
        harmonic_oscillator
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/hydrogen_like_atom/" class="md-nav__link">
        hydrogen_like_atom
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_2">
          mcmc
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="mcmc" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          mcmc
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mcmc/dynamic_width_position_amplitude/" class="md-nav__link">
        dynamic_width_position_amplitude
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mcmc/metropolis/" class="md-nav__link">
        metropolis
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mcmc/position_amplitude_core/" class="md-nav__link">
        position_amplitude_core
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mcmc/simple_position_amplitude/" class="md-nav__link">
        simple_position_amplitude
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mcmc/statistics/" class="md-nav__link">
        statistics
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3" type="checkbox" id="__nav_2_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_3">
          models
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="models" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          models
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../models/antiequivariance/" class="md-nav__link">
        antiequivariance
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../models/antisymmetry/" class="md-nav__link">
        antisymmetry
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../models/construct/" class="md-nav__link">
        construct
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../models/core/" class="md-nav__link">
        core
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../models/equivariance/" class="md-nav__link">
        equivariance
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../models/jastrow/" class="md-nav__link">
        jastrow
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../models/sign_symmetry/" class="md-nav__link">
        sign_symmetry
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../models/weights/" class="md-nav__link">
        weights
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_4" type="checkbox" id="__nav_2_4" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2_4">
          physics
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="physics" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_4">
          <span class="md-nav__icon md-icon"></span>
          physics
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          core
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        core
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#vmcnet.physics.core" class="md-nav__link">
    vmcnet.physics.core
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vmcnet.physics.core.initialize_molecular_pos" class="md-nav__link">
    initialize_molecular_pos()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vmcnet.physics.core.combine_local_energy_terms" class="md-nav__link">
    combine_local_energy_terms()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vmcnet.physics.core.laplacian_psi_over_psi" class="md-nav__link">
    laplacian_psi_over_psi()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vmcnet.physics.core.get_statistics_from_local_energy" class="md-nav__link">
    get_statistics_from_local_energy()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vmcnet.physics.core.get_default_energy_bwd" class="md-nav__link">
    get_default_energy_bwd()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vmcnet.physics.core.create_value_and_grad_energy_fn" class="md-nav__link">
    create_value_and_grad_energy_fn()
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kinetic/" class="md-nav__link">
        kinetic
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../potential/" class="md-nav__link">
        potential
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_5" type="checkbox" id="__nav_2_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_5">
          train
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="train" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_5">
          <span class="md-nav__icon md-icon"></span>
          train
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../train/default_config/" class="md-nav__link">
        default_config
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../train/parse_config_flags/" class="md-nav__link">
        parse_config_flags
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../train/runners/" class="md-nav__link">
        runners
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../train/vmc/" class="md-nav__link">
        vmc
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_6" type="checkbox" id="__nav_2_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_6">
          updates
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="updates" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_6">
          <span class="md-nav__icon md-icon"></span>
          updates
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../updates/params/" class="md-nav__link">
        params
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../updates/parse_config/" class="md-nav__link">
        parse_config
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../updates/sr/" class="md-nav__link">
        sr
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_7" type="checkbox" id="__nav_2_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_7">
          utils
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="utils" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_7">
          <span class="md-nav__icon md-icon"></span>
          utils
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/checkpoint/" class="md-nav__link">
        checkpoint
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/distribute/" class="md-nav__link">
        distribute
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/kfac/" class="md-nav__link">
        kfac
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/log_linear_exp/" class="md-nav__link">
        log_linear_exp
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/pytree_helpers/" class="md-nav__link">
        pytree_helpers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/slog_helpers/" class="md-nav__link">
        slog_helpers
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../CONTRIBUTING/" class="md-nav__link">
        Contributing
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#vmcnet.physics.core" class="md-nav__link">
    vmcnet.physics.core
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vmcnet.physics.core.initialize_molecular_pos" class="md-nav__link">
    initialize_molecular_pos()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vmcnet.physics.core.combine_local_energy_terms" class="md-nav__link">
    combine_local_energy_terms()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vmcnet.physics.core.laplacian_psi_over_psi" class="md-nav__link">
    laplacian_psi_over_psi()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vmcnet.physics.core.get_statistics_from_local_energy" class="md-nav__link">
    get_statistics_from_local_energy()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vmcnet.physics.core.get_default_energy_bwd" class="md-nav__link">
    get_default_energy_bwd()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vmcnet.physics.core.create_value_and_grad_energy_fn" class="md-nav__link">
    create_value_and_grad_energy_fn()
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                

  <h1>core</h1>

<div class="doc doc-object doc-module">

<a id="vmcnet.physics.core"></a>
    <div class="doc doc-contents first">

      <p>Core local energy and gradient construction routines.</p>



  <div class="doc doc-children">











  <div class="doc doc-object doc-function">



<h3 id="vmcnet.physics.core.initialize_molecular_pos" class="doc doc-heading">
<code class="highlight language-python"><span class="n">initialize_molecular_pos</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">nchains</span><span class="p">,</span> <span class="n">ion_pos</span><span class="p">,</span> <span class="n">ion_charges</span><span class="p">,</span> <span class="n">nelec_total</span><span class="p">,</span> <span class="n">init_width</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=&lt;</span><span class="k">class</span> <span class="err">&#39;</span><span class="nc">jax</span><span class="o">.</span><span class="n">_src</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">lax_numpy</span><span class="o">.</span><span class="n">float32</span><span class="s1">&#39;&gt;)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Initialize a set of plausible initial electron positions.</p>
<p>For each chain, each electron is assigned to a random ion and then its position is
sampled from a normal distribution centered at that ion with diagonal covariance
with diagonal entries all equal to init_width.</p>
<p>If there are no more electrons than there are ions, the assignment is done without
replacement. If there are more electrons than ions, the assignment is done with
replacement, and the probability of choosing ion i is its relative charge (as a
fraction of the sum of the ion charges).</p>

        <details class="quote">
          <summary>Source code in <code>vmcnet/physics/core.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">initialize_molecular_pos</span><span class="p">(</span>
    <span class="n">key</span><span class="p">:</span> <span class="n">PRNGKey</span><span class="p">,</span>
    <span class="n">nchains</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">ion_pos</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span>
    <span class="n">ion_charges</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span>
    <span class="n">nelec_total</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">init_width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">PRNGKey</span><span class="p">,</span> <span class="n">Array</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Initialize a set of plausible initial electron positions.</span>

<span class="sd">    For each chain, each electron is assigned to a random ion and then its position is</span>
<span class="sd">    sampled from a normal distribution centered at that ion with diagonal covariance</span>
<span class="sd">    with diagonal entries all equal to init_width.</span>

<span class="sd">    If there are no more electrons than there are ions, the assignment is done without</span>
<span class="sd">    replacement. If there are more electrons than ions, the assignment is done with</span>
<span class="sd">    replacement, and the probability of choosing ion i is its relative charge (as a</span>
<span class="sd">    fraction of the sum of the ion charges).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nion</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ion_charges</span><span class="p">)</span>
    <span class="n">replace</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">nelec_total</span> <span class="o">&lt;=</span> <span class="n">nion</span><span class="p">:</span>
        <span class="n">replace</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">assignments</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nchains</span><span class="p">):</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">subkey</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">choices</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
            <span class="n">subkey</span><span class="p">,</span>
            <span class="n">nion</span><span class="p">,</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nelec_total</span><span class="p">,),</span>
            <span class="n">replace</span><span class="o">=</span><span class="n">replace</span><span class="p">,</span>
            <span class="n">p</span><span class="o">=</span><span class="n">ion_charges</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ion_charges</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">assignments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ion_pos</span><span class="p">[</span><span class="n">choices</span><span class="p">])</span>
    <span class="n">elecs_at_ions</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">assignments</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">key</span><span class="p">,</span> <span class="n">subkey</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">key</span><span class="p">,</span> <span class="n">elecs_at_ions</span> <span class="o">+</span> <span class="n">init_width</span> <span class="o">*</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span>
        <span class="n">subkey</span><span class="p">,</span> <span class="n">elecs_at_ions</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="vmcnet.physics.core.combine_local_energy_terms" class="doc doc-heading">
<code class="highlight language-python"><span class="n">combine_local_energy_terms</span><span class="p">(</span><span class="n">local_energy_terms</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Combine a sequence of local energy terms by adding them.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>local_energy_terms</code></td>
        <td><code>Sequence</code></td>
        <td><p>sequence of local energy terms, each with the
signature (params, x) -&gt; array of terms of shape (x.shape[0],)</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Callable</code></td>
      <td><p>local energy function which computes the sum of the local energy
terms. Has the signature
(params, x) -&gt; local energy array of shape (x.shape[0],)</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>vmcnet/physics/core.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">combine_local_energy_terms</span><span class="p">(</span>
    <span class="n">local_energy_terms</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ModelApply</span><span class="p">[</span><span class="n">P</span><span class="p">]],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ModelApply</span><span class="p">[</span><span class="n">P</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Combine a sequence of local energy terms by adding them.</span>

<span class="sd">    Args:</span>
<span class="sd">        local_energy_terms (Sequence): sequence of local energy terms, each with the</span>
<span class="sd">            signature (params, x) -&gt; array of terms of shape (x.shape[0],)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Callable: local energy function which computes the sum of the local energy</span>
<span class="sd">        terms. Has the signature</span>
<span class="sd">        (params, x) -&gt; local energy array of shape (x.shape[0],)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">local_energy_fn</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">P</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
        <span class="n">local_energy_sum</span> <span class="o">=</span> <span class="n">local_energy_terms</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">local_energy_terms</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">local_energy_sum</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Array</span><span class="p">,</span> <span class="n">local_energy_sum</span> <span class="o">+</span> <span class="n">term</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">local_energy_sum</span>

    <span class="k">return</span> <span class="n">local_energy_fn</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="vmcnet.physics.core.laplacian_psi_over_psi" class="doc doc-heading">
<code class="highlight language-python"><span class="n">laplacian_psi_over_psi</span><span class="p">(</span><span class="n">grad_log_psi_apply</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Compute (nabla^2 psi) / psi at x given a function which evaluates psi'(x)/psi.</p>
<p>The computation is done by computing (forward-mode) derivatives of the gradient to
get the columns of the Hessian, and accumulating the (i, i)th entries (but this
implementation is significantly more memory efficient than directly computing the
Hessian).</p>
<p>This function uses the identity</p>
<div class="highlight"><pre><span></span><code>(nabla^2 psi) / psi = (nabla^2 log|psi|) + (nabla log|psi|)^2
</code></pre></div>
<p>to avoid leaving the log domain during the computation.</p>
<p>This function should be vmapped in order to be applied to batches of inputs, as it
completely flattens x in order to take second derivatives w.r.t. each component.</p>
<p>This is approach is extremely similar to the one in the FermiNet repo
(in the jax branch, as of this writing -- see
https://github.com/deepmind/ferminet/blob/aade61b3d30883b3238d6b50c85404d0e8176155/ferminet/hamiltonian.py).</p>
<p>The main difference is that we are being explicit about the flattening of x within
the Laplacian calculation, so that it does not have to be handled outside of this
function (psi is free to take x shapes which are not flat).</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>grad_log_psi_apply</code></td>
        <td><code>Callable</code></td>
        <td><p>function which evaluates the derivative of
log|psi(x)|, i.e. (nabla psi)(x) / psi(x), with respect to x. Has the
signature (params, x) -&gt; (nabla psi)(x) / psi(x), so the derivative should
be over the second arg, x, and the output shape should be the same as x</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>params</code></td>
        <td><code>pytree</code></td>
        <td><p>model parameters, passed as the first arg of grad_log_psi</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>x</code></td>
        <td><code>Array</code></td>
        <td><p>second input to grad_log_psi</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>jnp.float32</code></td>
      <td><p>"local" laplacian calculation, i.e. (nabla^2 psi) / psi</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>vmcnet/physics/core.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">laplacian_psi_over_psi</span><span class="p">(</span>
    <span class="n">grad_log_psi_apply</span><span class="p">:</span> <span class="n">ModelApply</span><span class="p">,</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">P</span><span class="p">,</span>
    <span class="n">x</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Compute (nabla^2 psi) / psi at x given a function which evaluates psi&#39;(x)/psi.</span>

<span class="sd">    The computation is done by computing (forward-mode) derivatives of the gradient to</span>
<span class="sd">    get the columns of the Hessian, and accumulating the (i, i)th entries (but this</span>
<span class="sd">    implementation is significantly more memory efficient than directly computing the</span>
<span class="sd">    Hessian).</span>

<span class="sd">    This function uses the identity</span>

<span class="sd">        (nabla^2 psi) / psi = (nabla^2 log|psi|) + (nabla log|psi|)^2</span>

<span class="sd">    to avoid leaving the log domain during the computation.</span>

<span class="sd">    This function should be vmapped in order to be applied to batches of inputs, as it</span>
<span class="sd">    completely flattens x in order to take second derivatives w.r.t. each component.</span>

<span class="sd">    This is approach is extremely similar to the one in the FermiNet repo</span>
<span class="sd">    (in the jax branch, as of this writing -- see</span>
<span class="sd">    https://github.com/deepmind/ferminet/blob/aade61b3d30883b3238d6b50c85404d0e8176155/ferminet/hamiltonian.py).</span>

<span class="sd">    The main difference is that we are being explicit about the flattening of x within</span>
<span class="sd">    the Laplacian calculation, so that it does not have to be handled outside of this</span>
<span class="sd">    function (psi is free to take x shapes which are not flat).</span>

<span class="sd">    Args:</span>
<span class="sd">        grad_log_psi_apply (Callable): function which evaluates the derivative of</span>
<span class="sd">            log|psi(x)|, i.e. (nabla psi)(x) / psi(x), with respect to x. Has the</span>
<span class="sd">            signature (params, x) -&gt; (nabla psi)(x) / psi(x), so the derivative should</span>
<span class="sd">            be over the second arg, x, and the output shape should be the same as x</span>
<span class="sd">        params (pytree): model parameters, passed as the first arg of grad_log_psi</span>
<span class="sd">        x (Array): second input to grad_log_psi</span>

<span class="sd">    Returns:</span>
<span class="sd">        jnp.float32: &quot;local&quot; laplacian calculation, i.e. (nabla^2 psi) / psi</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x_shape</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">flat_x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">flat_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">identity_mat</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">flattened_grad_log_psi_of_flat_x</span><span class="p">(</span><span class="n">flat_x_in</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Flattened input to flattened output version of grad_log_psi.&quot;&quot;&quot;</span>
        <span class="n">grad_log_psi_out</span> <span class="o">=</span> <span class="n">grad_log_psi_apply</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">flat_x_in</span><span class="p">,</span> <span class="n">x_shape</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">grad_log_psi_out</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,))</span>

    <span class="k">def</span> <span class="nf">step_fn</span><span class="p">(</span><span class="n">carry</span><span class="p">,</span> <span class="n">unused</span><span class="p">):</span>
        <span class="k">del</span> <span class="n">unused</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">carry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">primals</span><span class="p">,</span> <span class="n">tangents</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jvp</span><span class="p">(</span>
            <span class="n">flattened_grad_log_psi_of_flat_x</span><span class="p">,</span> <span class="p">(</span><span class="n">flat_x</span><span class="p">,),</span> <span class="p">(</span><span class="n">identity_mat</span><span class="p">[</span><span class="n">i</span><span class="p">],)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">carry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">primals</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="n">tangents</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="kc">None</span>

    <span class="n">out</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">step_fn</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">xs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="vmcnet.physics.core.get_statistics_from_local_energy" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_statistics_from_local_energy</span><span class="p">(</span><span class="n">local_energies</span><span class="p">,</span> <span class="n">nchains</span><span class="p">,</span> <span class="n">nan_safe</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Collectively reduce local energies to an average energy and variance.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>local_energies</code></td>
        <td><code>Array</code></td>
        <td><p>local energies of shape (nchains,), possibly
distributed across multiple devices via utils.distribute.pmap.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>nchains</code></td>
        <td><code>int</code></td>
        <td><p>total number of chains across all devices, used to compute a
sample variance estimate of the local energy</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>nan_safe</code></td>
        <td><code>bool</code></td>
        <td><p>flag which controls if jnp.nanmean is used instead of
jnp.mean. Can be set to False when debugging if trying to find the source of
unexpected nans. Defaults to True.</p></td>
        <td><code>True</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>(jnp.float32, jnp.float32)</code></td>
      <td><p>local energy average, local energy (sample) variance</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>vmcnet/physics/core.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_statistics_from_local_energy</span><span class="p">(</span>
    <span class="n">local_energies</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span> <span class="n">nchains</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">nan_safe</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Collectively reduce local energies to an average energy and variance.</span>

<span class="sd">    Args:</span>
<span class="sd">        local_energies (Array): local energies of shape (nchains,), possibly</span>
<span class="sd">            distributed across multiple devices via utils.distribute.pmap.</span>
<span class="sd">        nchains (int): total number of chains across all devices, used to compute a</span>
<span class="sd">            sample variance estimate of the local energy</span>
<span class="sd">        nan_safe (bool, optional): flag which controls if jnp.nanmean is used instead of</span>
<span class="sd">            jnp.mean. Can be set to False when debugging if trying to find the source of</span>
<span class="sd">            unexpected nans. Defaults to True.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (jnp.float32, jnp.float32): local energy average, local energy (sample) variance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO(Jeffmin) might be worth investigating the numerical stability of the XLA</span>
    <span class="c1"># compiled version of these two computations, since the quality of the gradients</span>
    <span class="c1"># is fairly crucial to the success of the algorithm</span>
    <span class="k">if</span> <span class="n">nan_safe</span><span class="p">:</span>
        <span class="n">allreduce_mean</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">distribute</span><span class="o">.</span><span class="n">nanmean_all_local_devices</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">allreduce_mean</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">distribute</span><span class="o">.</span><span class="n">mean_all_local_devices</span>
    <span class="n">energy</span> <span class="o">=</span> <span class="n">allreduce_mean</span><span class="p">(</span><span class="n">local_energies</span><span class="p">)</span>
    <span class="n">variance</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">allreduce_mean</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">local_energies</span> <span class="o">-</span> <span class="n">energy</span><span class="p">))</span> <span class="o">*</span> <span class="n">nchains</span> <span class="o">/</span> <span class="p">(</span><span class="n">nchains</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>  <span class="c1"># adjust by n / (n - 1) to get an unbiased estimator</span>
    <span class="k">return</span> <span class="n">energy</span><span class="p">,</span> <span class="n">variance</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="vmcnet.physics.core.get_default_energy_bwd" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_default_energy_bwd</span><span class="p">(</span><span class="n">log_psi_apply</span><span class="p">,</span> <span class="n">mean_grad_fn</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Use a standard variance reduction formula to get the bwd pass of the energy.</p>
<p>The formula is 2 * E_p[(local_e - E_p[local_e]) * grad_log_psi], where the
symbol E_p[] refers to the expectation over the probability distribution p defined
by p(x) = |psi(x)|^2 / <psi | psi>. This is an unbiased estimator of the gradient
of E_p[local_e], and has a lower variance than directly differentiating E_p[local_e]
with respect to the parameters.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>log_psi_apply</code></td>
        <td><code>Callable</code></td>
        <td><p>computes log|psi(x)|, where the signature of this
function is (params, x) -&gt; log|psi(x)|</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>mean_grad_fn</code></td>
        <td><code>Callable</code></td>
        <td><p>function which is used to average the local gradient
terms over all local devices. Has the signature local_grads -&gt; avg_grad / 2,
and should only average over the batch axis 0.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Callable</code></td>
      <td><p>function which computes the backward pass in the custom vjp of the
total energy. Has the signature (res, cotangents) -&gt; (gradients, None)</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>vmcnet/physics/core.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_default_energy_bwd</span><span class="p">(</span>
    <span class="n">log_psi_apply</span><span class="p">:</span> <span class="n">ModelApply</span><span class="p">[</span><span class="n">P</span><span class="p">],</span>
    <span class="n">mean_grad_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Array</span><span class="p">],</span> <span class="n">Array</span><span class="p">],</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Use a standard variance reduction formula to get the bwd pass of the energy.</span>

<span class="sd">    The formula is 2 * E_p[(local_e - E_p[local_e]) * grad_log_psi], where the</span>
<span class="sd">    symbol E_p[] refers to the expectation over the probability distribution p defined</span>
<span class="sd">    by p(x) = |psi(x)|^2 / &lt;psi | psi&gt;. This is an unbiased estimator of the gradient</span>
<span class="sd">    of E_p[local_e], and has a lower variance than directly differentiating E_p[local_e]</span>
<span class="sd">    with respect to the parameters.</span>

<span class="sd">    Args:</span>
<span class="sd">        log_psi_apply (Callable): computes log|psi(x)|, where the signature of this</span>
<span class="sd">            function is (params, x) -&gt; log|psi(x)|</span>
<span class="sd">        mean_grad_fn (Callable): function which is used to average the local gradient</span>
<span class="sd">            terms over all local devices. Has the signature local_grads -&gt; avg_grad / 2,</span>
<span class="sd">            and should only average over the batch axis 0.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Callable: function which computes the backward pass in the custom vjp of the</span>
<span class="sd">        total energy. Has the signature (res, cotangents) -&gt; (gradients, None)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">scaled_by_local_e</span><span class="p">(</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">P</span><span class="p">,</span> <span class="n">positions</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span> <span class="n">centered_local_energies</span><span class="p">:</span> <span class="n">Array</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">:</span>
        <span class="n">log_psi</span> <span class="o">=</span> <span class="n">log_psi_apply</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">positions</span><span class="p">)</span>
        <span class="n">loss_functions</span><span class="o">.</span><span class="n">register_normal_predictive_distribution</span><span class="p">(</span><span class="n">log_psi</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span>
        <span class="k">return</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">mean_grad_fn</span><span class="p">(</span><span class="n">centered_local_energies</span> <span class="o">*</span> <span class="n">log_psi</span><span class="p">)</span>

    <span class="n">_get_energy_grad</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">scaled_by_local_e</span><span class="p">,</span> <span class="n">argnums</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">energy_bwd</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">cotangents</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="n">energy</span><span class="p">,</span> <span class="n">local_energies</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">positions</span> <span class="o">=</span> <span class="n">res</span>
        <span class="n">centered_local_energies</span> <span class="o">=</span> <span class="n">local_energies</span> <span class="o">-</span> <span class="n">energy</span>
        <span class="n">gradient</span> <span class="o">=</span> <span class="n">_get_energy_grad</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">centered_local_energies</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree_map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="n">cotangents</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gradient</span><span class="p">),</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">energy_bwd</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="vmcnet.physics.core.create_value_and_grad_energy_fn" class="doc doc-heading">
<code class="highlight language-python"><span class="n">create_value_and_grad_energy_fn</span><span class="p">(</span><span class="n">log_psi_apply</span><span class="p">,</span> <span class="n">local_energy_fn</span><span class="p">,</span> <span class="n">nchains</span><span class="p">,</span> <span class="n">clipping_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nan_safe</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">get_energy_bwd</span><span class="o">=&lt;</span><span class="n">function</span> <span class="n">get_default_energy_bwd</span> <span class="n">at</span> <span class="mh">0x7ff1729ab940</span><span class="o">&gt;</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Create a function which computes unbiased energy gradients.</p>
<p>Due to the Hermiticity of the Hamiltonian, we can get an unbiased lower variance
estimate of the gradient of the expected energy than the naive gradient of the
mean of sampled local energies. Specifically, the gradient of the expected energy
expect[E_L] takes the form</p>
<div class="highlight"><pre><span></span><code>2 * expect[(E_L - expect[E_L]) * (grad_psi / psi)(x)],
</code></pre></div>
<p>where E_L is the local energy and expect[] denotes the expectation with respect to
the distribution |psi|^2.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>log_psi_apply</code></td>
        <td><code>Callable</code></td>
        <td><p>computes log|psi(x)|, where the signature of this
function is (params, x) -&gt; log|psi(x)|</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>local_energy_fn</code></td>
        <td><code>Callable</code></td>
        <td><p>computes local energies Hpsi / psi. Has signature
(params, x) -&gt; (Hpsi / psi)(x)</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>nchains</code></td>
        <td><code>int</code></td>
        <td><p>total number of chains across all devices, used to compute a
sample variance estimate of the local energy</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>clipping_fn</code></td>
        <td><code>Callable</code></td>
        <td><p>post-processing function on the local energy,
e.g. a function which clips the values to be within some multiple of the
total variation from the median. The post-processed values are used for
the gradient calculation, if available. Defaults to None.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>nan_safe</code></td>
        <td><code>bool</code></td>
        <td><p>flag which controls if jnp.nanmean and jnp.nansum are
used instead of jnp.mean and jnp.sum for the terms in the gradient
calculation. Can be set to False when debugging if trying to find the source
of unexpected nans. Defaults to True.</p></td>
        <td><code>True</code></td>
      </tr>
      <tr>
        <td><code>get_energy_bwd</code></td>
        <td><code>Callable</code></td>
        <td><p>function which returns a custom backward pass for the
total energy calculation. Has the signature
    (log_psi_apply, mean_grad_fn) -&gt; energy_bwd.
Defaults to get_default_energy_bwd, which computes the formula above.</p></td>
        <td><code>&lt;function get_default_energy_bwd at 0x7ff1729ab940&gt;</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Callable</code></td>
      <td><p>function which computes the clipped energy value and gradient. Has the
signature
    (params, x)
    -&gt; ((expected_energy, auxiliary_energy_data), grad_energy),
where auxiliary_energy_data is the tuple
(expected_variance, local_energies, unclipped_energy, unclipped_variance)</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>vmcnet/physics/core.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">create_value_and_grad_energy_fn</span><span class="p">(</span>
    <span class="n">log_psi_apply</span><span class="p">:</span> <span class="n">ModelApply</span><span class="p">[</span><span class="n">P</span><span class="p">],</span>
    <span class="n">local_energy_fn</span><span class="p">:</span> <span class="n">ModelApply</span><span class="p">[</span><span class="n">P</span><span class="p">],</span>
    <span class="n">nchains</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">clipping_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Array</span><span class="p">],</span> <span class="n">Array</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">nan_safe</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">get_energy_bwd</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">get_default_energy_bwd</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ValueGradEnergyFn</span><span class="p">[</span><span class="n">P</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Create a function which computes unbiased energy gradients.</span>

<span class="sd">    Due to the Hermiticity of the Hamiltonian, we can get an unbiased lower variance</span>
<span class="sd">    estimate of the gradient of the expected energy than the naive gradient of the</span>
<span class="sd">    mean of sampled local energies. Specifically, the gradient of the expected energy</span>
<span class="sd">    expect[E_L] takes the form</span>

<span class="sd">        2 * expect[(E_L - expect[E_L]) * (grad_psi / psi)(x)],</span>

<span class="sd">    where E_L is the local energy and expect[] denotes the expectation with respect to</span>
<span class="sd">    the distribution |psi|^2.</span>

<span class="sd">    Args:</span>
<span class="sd">        log_psi_apply (Callable): computes log|psi(x)|, where the signature of this</span>
<span class="sd">            function is (params, x) -&gt; log|psi(x)|</span>
<span class="sd">        local_energy_fn (Callable): computes local energies Hpsi / psi. Has signature</span>
<span class="sd">            (params, x) -&gt; (Hpsi / psi)(x)</span>
<span class="sd">        nchains (int): total number of chains across all devices, used to compute a</span>
<span class="sd">            sample variance estimate of the local energy</span>
<span class="sd">        clipping_fn (Callable, optional): post-processing function on the local energy,</span>
<span class="sd">            e.g. a function which clips the values to be within some multiple of the</span>
<span class="sd">            total variation from the median. The post-processed values are used for</span>
<span class="sd">            the gradient calculation, if available. Defaults to None.</span>
<span class="sd">        nan_safe (bool, optional): flag which controls if jnp.nanmean and jnp.nansum are</span>
<span class="sd">            used instead of jnp.mean and jnp.sum for the terms in the gradient</span>
<span class="sd">            calculation. Can be set to False when debugging if trying to find the source</span>
<span class="sd">            of unexpected nans. Defaults to True.</span>
<span class="sd">        get_energy_bwd (Callable): function which returns a custom backward pass for the</span>
<span class="sd">            total energy calculation. Has the signature</span>
<span class="sd">                (log_psi_apply, mean_grad_fn) -&gt; energy_bwd.</span>
<span class="sd">            Defaults to get_default_energy_bwd, which computes the formula above.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Callable: function which computes the clipped energy value and gradient. Has the</span>
<span class="sd">        signature</span>
<span class="sd">            (params, x)</span>
<span class="sd">            -&gt; ((expected_energy, auxiliary_energy_data), grad_energy),</span>
<span class="sd">        where auxiliary_energy_data is the tuple</span>
<span class="sd">        (expected_variance, local_energies, unclipped_energy, unclipped_variance)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@jax</span><span class="o">.</span><span class="n">custom_vjp</span>
    <span class="k">def</span> <span class="nf">compute_energy_data</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">P</span><span class="p">,</span> <span class="n">positions</span><span class="p">:</span> <span class="n">Array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnergyData</span><span class="p">:</span>
        <span class="n">local_energies_noclip</span> <span class="o">=</span> <span class="n">local_energy_fn</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">positions</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">clipping_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">local_energies</span> <span class="o">=</span> <span class="n">clipping_fn</span><span class="p">(</span><span class="n">local_energies_noclip</span><span class="p">)</span>
            <span class="n">energy</span><span class="p">,</span> <span class="n">variance</span> <span class="o">=</span> <span class="n">get_statistics_from_local_energy</span><span class="p">(</span>
                <span class="n">local_energies</span><span class="p">,</span> <span class="n">nchains</span><span class="p">,</span> <span class="n">nan_safe</span><span class="o">=</span><span class="n">nan_safe</span>
            <span class="p">)</span>

            <span class="c1"># For the unclipped metrics, which are not used in the gradient, don&#39;t</span>
            <span class="c1"># do these in a nan-safe way. This makes nans more visible and makes sure</span>
            <span class="c1"># the command-line checkpoint_if_nans flag will work properly.</span>
            <span class="n">energy_noclip</span><span class="p">,</span> <span class="n">variance_noclip</span> <span class="o">=</span> <span class="n">get_statistics_from_local_energy</span><span class="p">(</span>
                <span class="n">local_energies_noclip</span><span class="p">,</span> <span class="n">nchains</span><span class="p">,</span> <span class="n">nan_safe</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>

            <span class="n">aux_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">variance</span><span class="p">,</span> <span class="n">local_energies</span><span class="p">,</span> <span class="n">energy_noclip</span><span class="p">,</span> <span class="n">variance_noclip</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">local_energies</span> <span class="o">=</span> <span class="n">local_energies_noclip</span>
            <span class="n">energy</span><span class="p">,</span> <span class="n">variance</span> <span class="o">=</span> <span class="n">get_statistics_from_local_energy</span><span class="p">(</span>
                <span class="n">local_energies</span><span class="p">,</span> <span class="n">nchains</span><span class="p">,</span> <span class="n">nan_safe</span><span class="o">=</span><span class="n">nan_safe</span>
            <span class="p">)</span>

            <span class="c1"># Even though there&#39;s no clipping function, still record noclip metrics</span>
            <span class="c1"># without nan-safety so that checkpointing epochs with nans can be</span>
            <span class="c1"># supported.</span>
            <span class="n">energy_noclip</span><span class="p">,</span> <span class="n">variance_noclip</span> <span class="o">=</span> <span class="n">get_statistics_from_local_energy</span><span class="p">(</span>
                <span class="n">local_energies</span><span class="p">,</span> <span class="n">nchains</span><span class="p">,</span> <span class="n">nan_safe</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="n">aux_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">variance</span><span class="p">,</span> <span class="n">local_energies</span><span class="p">,</span> <span class="n">energy_noclip</span><span class="p">,</span> <span class="n">variance_noclip</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">energy</span><span class="p">,</span> <span class="n">aux_data</span>

    <span class="k">def</span> <span class="nf">energy_fwd</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">P</span><span class="p">,</span> <span class="n">positions</span><span class="p">:</span> <span class="n">Array</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">compute_energy_data</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">positions</span><span class="p">)</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">local_energies</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="n">local_energies</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">positions</span><span class="p">)</span>

    <span class="n">mean_grad_fn</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">distribute</span><span class="o">.</span><span class="n">get_mean_over_first_axis_fn</span><span class="p">(</span><span class="n">nan_safe</span><span class="o">=</span><span class="n">nan_safe</span><span class="p">)</span>
    <span class="n">energy_bwd</span> <span class="o">=</span> <span class="n">get_energy_bwd</span><span class="p">(</span><span class="n">log_psi_apply</span><span class="p">,</span> <span class="n">mean_grad_fn</span><span class="p">)</span>

    <span class="n">compute_energy_data</span><span class="o">.</span><span class="n">defvjp</span><span class="p">(</span><span class="n">energy_fwd</span><span class="p">,</span> <span class="n">energy_bwd</span><span class="p">)</span>

    <span class="n">energy_data_val_and_grad</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">value_and_grad</span><span class="p">(</span>
        <span class="n">compute_energy_data</span><span class="p">,</span> <span class="n">argnums</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">has_aux</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">energy_data_val_and_grad</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../../models/weights/" class="md-footer__link md-footer__link--prev" aria-label="Previous: weights" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              weights
            </div>
          </div>
        </a>
      
      
        
        <a href="../kinetic/" class="md-footer__link md-footer__link--next" aria-label="Next: kinetic" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              kinetic
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.instant", "navigation.tabs", "navigation.tabs.sticky", "navigation.tracking"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../../assets/javascripts/workers/search.cefbb252.min.js", "version": {"provider": "mike"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.a5f8ea78.min.js"></script>
      
    
  </body>
</html>